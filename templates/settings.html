{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block css %}
<style>
/* ── Settings Layout ───────────────────────────────── */
.settings-wrapper {
    max-width: 760px;
    margin: 0 auto;
    padding-bottom: 60px;
}

.settings-page-title {
    font-size: 26px;
    font-weight: 800;
    color: #1a1a1a;
    margin-bottom: 28px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ── Section Card ──────────────────────────────────── */
.settings-section {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    margin-bottom: 24px;
    overflow: hidden;
}

/* ── Settings action buttons (Change Email / Change Password) ── */
.settings-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 10px 18px;
    background: #f0f4ff;
    color: #4f46e5;
    border: 1.5px solid #c7d2fe;
    border-radius: 9px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}
.settings-action-btn:hover {
    background: #e0e7ff;
    border-color: #818cf8;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(99,102,241,0.15);
}
.settings-action-btn.active {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
}

/* ── Expandable panels ─────────────────────────────── */
.expandable-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease, opacity 0.3s ease;
    opacity: 0;
    border-top: 0px solid #e5e7eb;
}
.expandable-panel.open {
    max-height: 500px;
    opacity: 1;
    border-top: 2px dashed #e0e7ff;
}
.panel-inner {
    padding: 24px 28px;
    background: #fafbff;
}
.panel-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e0e7ff;
}

.section-header {
    padding: 22px 28px;
    border-bottom: 2px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header h3 {
    margin: 0;
    font-size: 17px;
    font-weight: 700;
    color: #1a1a1a;
}

.section-header .section-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.icon-blue  { background: #eff6ff; }
.icon-red   { background: #fef2f2; }

.section-body {
    padding: 28px;
}

/* ── Form Rows ─────────────────────────────────────── */
.settings-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.settings-row.full {
    grid-template-columns: 1fr;
}

.field-group {
    display: flex;
    flex-direction: column;
    gap: 7px;
}

.field-group label {
    font-size: 13px;
    font-weight: 700;
    color: #374151;
    letter-spacing: 0.02em;
}

.field-group .field-hint {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 3px;
}

.settings-input {
    padding: 11px 14px;
    border: 1.5px solid #e5e7eb;
    border-radius: 9px;
    font-size: 14px;
    color: #1f2937;
    background: white;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-family: inherit;
    width: 100%;
    box-sizing: border-box;
}

.settings-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.12);
}

.settings-input.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239,68,68,0.1);
}

/* ── Password strength ─────────────────────────────── */
.strength-bar {
    height: 4px;
    border-radius: 4px;
    background: #e5e7eb;
    margin-top: 6px;
    overflow: hidden;
}

.strength-fill {
    height: 100%;
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s, background 0.3s;
}

.strength-label {
    font-size: 12px;
    margin-top: 4px;
    font-weight: 600;
}

/* ── Section footer ────────────────────────────────── */
.section-footer {
    padding: 18px 28px;
    background: #f9fafb;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* ── Alert flash ───────────────────────────────────── */
.alert {
    padding: 13px 18px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
.alert-error   { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

/* ── Danger Zone ───────────────────────────────────── */
.danger-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 0;
    border-bottom: 1px solid #fee2e2;
}

.danger-item:last-child { border-bottom: none; padding-bottom: 0; }
.danger-item:first-child { padding-top: 0; }

.danger-item-info h4 {
    font-size: 15px;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 4px;
}

.danger-item-info p {
    font-size: 13px;
    color: #6b7280;
    margin: 0;
}

.btn-danger {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    border: 1.5px solid #ef4444;
    background: white;
    color: #ef4444;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    margin-left: 20px;
}

.btn-danger:hover {
    background: #ef4444;
    color: white;
}

.btn-danger.btn-danger-fill {
    background: #ef4444;
    color: white;
}

.btn-danger.btn-danger-fill:hover {
    background: #dc2626;
    border-color: #dc2626;
}

/* ── Confirm overlay ───────────────────────────────── */
.danger-confirm-box {
    display: none;
    background: #fef2f2;
    border: 1.5px solid #fca5a5;
    border-radius: 10px;
    padding: 16px 20px;
    margin-top: 14px;
}

.danger-confirm-box.show { display: block; }

.danger-confirm-box p {
    font-size: 13px;
    color: #7f1d1d;
    margin: 0 0 10px;
}

.danger-confirm-box input {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid #fca5a5;
    border-radius: 7px;
    font-size: 14px;
    margin-bottom: 12px;
    box-sizing: border-box;
    background: white;
}

.danger-confirm-box input:focus {
    outline: none;
    border-color: #ef4444;
}

.danger-confirm-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* ── Buttons ───────────────────────────────────────── */
.btn-save {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 26px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 9px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(102,126,234,0.25);
}

.btn-save:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(102,126,234,0.35);
}

.btn-save:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-cancel-settings {
    display: inline-flex;
    align-items: center;
    padding: 12px 20px;
    background: #f3f4f6;
    color: #6b7280;
    border: none;
    border-radius: 9px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-cancel-settings:hover { background: #e5e7eb; color: #374151; }

@media (max-width: 600px) {
    .settings-row { grid-template-columns: 1fr; }
    .danger-item { flex-direction: column; align-items: flex-start; gap: 10px; }
    .btn-danger { margin-left: 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="settings-wrapper">

  <h2 class="settings-page-title">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
      <circle cx="12" cy="12" r="3"/>
      <path d="M12 1v3m0 16v3M4.22 4.22l2.12 2.12m11.32 11.32 2.12 2.12M1 12h3m16 0h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/>
    </svg>
    Settings
  </h2>

  <!-- Flash messages -->
  {% if success_msg %}
  <div class="alert alert-success">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
    {{ success_msg }}
  </div>
  {% endif %}
  {% if error_msg %}
  <div class="alert alert-error">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    {{ error_msg }}
  </div>
  {% endif %}

  <!-- ── Account Settings ──────────────────────────── -->
  <div class="settings-section">
    <div class="section-header">
      <div class="section-icon icon-blue">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4A90E2" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
        </svg>
      </div>
      <h3>Account Settings</h3>
    </div>

    <!-- ── Profile Info ── -->
    <form method="POST" action="/settings/account">
      <div class="section-body">
        <div class="settings-row">
          <div class="field-group">
            <label for="full_name">Full Name</label>
            <input type="text" id="full_name" name="full_name" class="settings-input"
                   placeholder="Your full name" value="{{ user.full_name or '' }}" maxlength="100">
          </div>
          <div class="field-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" class="settings-input"
                   placeholder="username" value="{{ user.username or '' }}" required maxlength="50">
            <span class="field-hint">Used to log in. Must be unique.</span>
          </div>
        </div>
        <div class="field-group" style="margin-top:4px;">
          <label>Email Address</label>
          <div style="padding:11px 14px; border:1.5px solid #e5e7eb; border-radius:9px; font-size:14px; color:#9ca3af; background:#f9fafb;">
            {{ user.email }}
          </div>
          <span class="field-hint">To change your email use the button below.</span>
        </div>
      </div>
      <div class="section-footer" style="justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:10px;">
          <button type="button" class="settings-action-btn" onclick="togglePanel('emailPanel')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            Change Email
          </button>
          <button type="button" class="settings-action-btn" onclick="togglePanel('passwordPanel')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            Change Password
          </button>
        </div>
        <button type="submit" class="btn-save">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          Save Profile
        </button>
      </div>
    </form>

    <!-- ── Change Email Panel ── -->
    <div class="expandable-panel" id="emailPanel">
      <div class="panel-inner">
        <div class="panel-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          Change Email Address
        </div>
        <form method="POST" action="/settings/change-email">
          <div class="settings-row">
            <div class="field-group">
              <label for="new_email">New Email Address</label>
              <input type="email" id="new_email" name="new_email" class="settings-input"
                     placeholder="new@email.com" required>
            </div>
            <div class="field-group">
              <label for="email_password">Current Password</label>
              <input type="password" id="email_password" name="password" class="settings-input"
                     placeholder="Confirm with your password" required>
              <span class="field-hint">Required to verify it's you.</span>
            </div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:8px;">
            <button type="button" class="btn-cancel-settings" onclick="togglePanel('emailPanel')">Cancel</button>
            <button type="submit" class="btn-save">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
              Update Email
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ── Change Password Panel ── -->
    <div class="expandable-panel" id="passwordPanel">
      <div class="panel-inner">
        <div class="panel-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Change Password
        </div>
        <form method="POST" action="/settings/change-password">
          <div class="settings-row full" style="margin-bottom:16px;">
            <div class="field-group">
              <label for="cur_password">Current Password</label>
              <input type="password" id="cur_password" name="current_password" class="settings-input"
                     placeholder="Enter current password" required>
            </div>
          </div>
          <div class="settings-row">
            <div class="field-group">
              <label for="new_password">New Password</label>
              <input type="password" id="new_password" name="new_password" class="settings-input"
                     placeholder="Min 8 characters" oninput="checkStrength(this.value)" required>
              <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
              <span class="strength-label" id="strengthLabel" style="color:#9ca3af;"></span>
            </div>
            <div class="field-group">
              <label for="confirm_password">Confirm New Password</label>
              <input type="password" id="confirm_password" name="confirm_password" class="settings-input"
                     placeholder="Repeat new password" oninput="checkMatch()" required>
              <span class="field-hint" id="matchHint"></span>
            </div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:8px;">
            <button type="button" class="btn-cancel-settings" onclick="togglePanel('passwordPanel')">Cancel</button>
            <button type="submit" class="btn-save" id="savePwdBtn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
              Update Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ── Danger Zone ───────────────────────────────── -->
  <div class="settings-section">
    <div class="section-header">
      <div class="section-icon icon-red">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <h3 style="color:#dc2626;">Delete Account & Data</h3>
    </div>

    <div class="section-body">

      <!-- Clear all datasets -->
      <div class="danger-item">
        <div class="danger-item-info">
          <h4>Clear All Datasets</h4>
          <p>Permanently delete all your uploaded files and data. Categories are kept.</p>
        </div>
        <button class="btn-danger" onclick="toggleConfirm('clearDatasets')">Clear Datasets</button>
      </div>
      <div class="danger-confirm-box" id="confirm-clearDatasets">
        <p>Type <strong>DELETE</strong> to confirm you want to remove all datasets permanently.</p>
        <input type="text" id="input-clearDatasets" placeholder="Type DELETE here...">
        <div class="danger-confirm-actions">
          <button class="btn-cancel-settings" onclick="toggleConfirm('clearDatasets')">Cancel</button>
          <button class="btn-danger btn-danger-fill" onclick="executeDangerAction('clear-datasets', 'clearDatasets')">Yes, Delete All Datasets</button>
        </div>
      </div>

      <!-- Delete account -->
      <div class="danger-item">
        <div class="danger-item-info">
          <h4>Delete Account</h4>
          <p>Permanently delete your account, all datasets, and all categories. This cannot be undone.</p>
        </div>
        <button class="btn-danger btn-danger-fill" onclick="toggleConfirm('deleteAccount')">Delete Account</button>
      </div>
      <div class="danger-confirm-box" id="confirm-deleteAccount">
        <p>Type your username <strong>{{ user.username }}</strong> to confirm account deletion.</p>
        <input type="text" id="input-deleteAccount" placeholder="Type your username...">
        <div class="danger-confirm-actions">
          <button class="btn-cancel-settings" onclick="toggleConfirm('deleteAccount')">Cancel</button>
          <button class="btn-danger btn-danger-fill" onclick="executeDangerAction('delete-account', 'deleteAccount')">Yes, Delete My Account</button>
        </div>
      </div>

    </div>
  </div>

</div><!-- /settings-wrapper -->
{% endblock %}

{% block js %}
<script>
// ── Password strength meter ───────────────────────────────────────────────
function checkStrength(val) {
  const fill  = document.getElementById('strengthFill');
  const label = document.getElementById('strengthLabel');
  let score = 0;
  if (val.length >= 8)  score++;
  if (/[A-Z]/.test(val)) score++;
  if (/[0-9]/.test(val)) score++;
  if (/[^A-Za-z0-9]/.test(val)) score++;

  const levels = [
    { pct: '0%',   color: '#e5e7eb', text: '' },
    { pct: '25%',  color: '#ef4444', text: 'Weak' },
    { pct: '50%',  color: '#f59e0b', text: 'Fair' },
    { pct: '75%',  color: '#3b82f6', text: 'Good' },
    { pct: '100%', color: '#10b981', text: 'Strong' },
  ];
  const l = levels[val.length === 0 ? 0 : score];
  fill.style.width    = l.pct;
  fill.style.background = l.color;
  label.textContent   = l.text;
  label.style.color   = l.color;
}

// ── Password match ────────────────────────────────────────────────────────
function checkMatch() {
  const np  = document.getElementById('new_password').value;
  const cp  = document.getElementById('confirm_password').value;
  const hint = document.getElementById('matchHint');
  if (!cp) { hint.textContent = ''; return; }
  if (np === cp) {
    hint.textContent = '✓ Passwords match';
    hint.style.color = '#10b981';
    document.getElementById('confirm_password').classList.remove('error');
  } else {
    hint.textContent = '✗ Passwords do not match';
    hint.style.color = '#ef4444';
    document.getElementById('confirm_password').classList.add('error');
  }
}

// ── Toggle expandable panels ──────────────────────────────────────────────
function togglePanel(id) {
  const panel = document.getElementById(id);
  const isOpen = panel.classList.contains('open');
  // Close all panels first
  document.querySelectorAll('.expandable-panel').forEach(p => {
    p.classList.remove('open');
  });
  document.querySelectorAll('.settings-action-btn').forEach(b => {
    b.classList.remove('active');
  });
  // Open clicked one if it was closed
  if (!isOpen) {
    panel.classList.add('open');
    // Mark the button active
    const btns = document.querySelectorAll('.settings-action-btn');
    btns.forEach(b => {
      if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(id)) {
        b.classList.add('active');
      }
    });
    // Focus first input in panel
    setTimeout(() => {
      const first = panel.querySelector('input');
      if (first) first.focus();
    }, 350);
  }
}

// ── Password form validation ───────────────────────────────────────────────
const pwdForm = document.querySelector('form[action="/settings/change-password"]');
if (pwdForm) {
  pwdForm.addEventListener('submit', function(e) {
    const np  = document.getElementById('new_password').value;
    const cp  = document.getElementById('confirm_password').value;
    const cur = document.getElementById('cur_password').value;
    if (!cur) { e.preventDefault(); alert('Please enter your current password.'); return; }
    if (np.length < 8) { e.preventDefault(); alert('New password must be at least 8 characters.'); return; }
    if (np !== cp) { e.preventDefault(); alert('New passwords do not match.'); return; }
  });
}

// ── Danger Zone ───────────────────────────────────────────────────────────
function toggleConfirm(id) {
  const box = document.getElementById('confirm-' + id);
  box.classList.toggle('show');
  if (!box.classList.contains('show')) {
    document.getElementById('input-' + id).value = '';
  }
}

async function executeDangerAction(action, confirmId) {
  const input = document.getElementById('input-' + confirmId).value.trim();

  // Validation
  if (action === 'clear-datasets' && input !== 'DELETE') {
    alert('Please type DELETE exactly to confirm.');
    return;
  }
  if (action === 'delete-account' && input !== '{{ user.username }}') {
    alert('Username does not match. Please type your username exactly.');
    return;
  }

  try {
    const res = await fetch('/settings/' + action, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      if (action === 'delete-account') {
        window.location.href = '/logout';
      } else {
        window.location.href = '/dashboard';
      }
    } else {
      alert('Error: ' + (data.error || 'Action failed'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}
</script>
{% endblock %}