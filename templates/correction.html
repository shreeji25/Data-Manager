{% set show_header = False %}

{% block css %}
<link rel="stylesheet" href="/static/css/common.css">
<link rel="stylesheet" href="/static/css/loading.css">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: #f1f5f9;
  min-height: 100vh;
  color: #111827;
}

.correction-container {
  max-width: 1300px;
  margin: 0 auto;
  padding: 28px 24px 50px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* â•â• PAGE HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-header {
  background: #fff;
  border-radius: 12px;
  border-left: 5px solid #2563eb;
  padding: 18px 22px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 1px 6px rgba(0,0,0,0.07);
}
.page-title { font-size: 20px; font-weight: 700; color: #111827; }
.page-subtitle { font-size: 13px; color: #6b7280; margin-top: 4px; }

/* Steps */
.steps { display: flex; align-items: center; }
.step {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; font-weight: 600; color: #9ca3af;
}
.step.done  { color: #16a34a; }
.step.active { color: #2563eb; }
.step-circle {
  width: 24px; height: 24px; border-radius: 50%;
  background: #e5e7eb; color: #9ca3af;
  font-size: 11px; font-weight: 700;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.step.done   .step-circle { background: #dcfce7; color: #16a34a; }
.step.active .step-circle { background: #2563eb; color: #fff; box-shadow: 0 0 0 3px #dbeafe; }
.step-line { width: 28px; height: 2px; background: #e5e7eb; margin: 0 5px; }
.step-line.done { background: #16a34a; }

/* â•â• WARNING BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.warn-banner {
  background: #fffbeb;
  border: 1.5px solid #fcd34d;
  border-left: 4px solid #f59e0b;
  border-radius: 10px;
  padding: 12px 18px;
  display: flex; gap: 10px; align-items: flex-start;
  font-size: 13px; color: #78350f;
}
.warn-icon { font-size: 17px; flex-shrink: 0; margin-top: 1px; }
.warn-text b { display: block; font-weight: 700; margin-bottom: 2px; color: #92400e; }

/* â•â• INSTRUCTION CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.instructions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.instr-card {
  background: #fff;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  padding: 13px 14px;
  display: flex; gap: 10px; align-items: flex-start;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.instr-num {
  width: 22px; height: 22px;
  background: #eff6ff; color: #2563eb;
  border: 1.5px solid #bfdbfe;
  border-radius: 50%; font-size: 11px; font-weight: 800;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.instr-body { font-size: 12px; color: #374151; line-height: 1.5; }
.instr-body b { color: #111827; font-weight: 700; display: block; margin-bottom: 2px; font-size: 12.5px; }

/* â•â• TABLE CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.table-card {
  background: #fff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 1px 6px rgba(0,0,0,0.07);
  overflow: hidden;
}
.table-topbar {
  padding: 11px 18px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  display: flex; align-items: center; justify-content: space-between;
}
.table-topbar-label {
  font-size: 12px; font-weight: 700; color: #475569;
  text-transform: uppercase; letter-spacing: 0.06em;
  display: flex; align-items: center; gap: 8px;
}
.badge {
  font-size: 11px; font-weight: 700;
  padding: 2px 9px; border-radius: 20px;
  letter-spacing: 0; text-transform: none;
}
.badge-blue  { background: #e0e7ff; color: #3730a3; }
.badge-amber { background: #fef9c3; color: #854d0e; }

/* Table scroll */
.table-scroll {
  overflow-x: auto; overflow-y: auto;
  max-height: 420px;
}
.table-scroll::-webkit-scrollbar { height: 7px; width: 7px; }
.table-scroll::-webkit-scrollbar-track { background: #f8fafc; }
.table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
.table-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* â•â• THE TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fix-table {
  width: 100%;
  border-collapse: collapse;
  min-width: max-content;
}

/* Row 1 â€” original headers */
.fix-table thead tr.orig-row th {
  background: #1e293b;
  color: #64748b;
  font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.05em;
  padding: 10px 28px 10px 12px;
  white-space: nowrap;
  border-right: 1px solid rgba(255,255,255,0.06);
  border-bottom: 1px solid #0f172a;
  position: relative;
  user-select: none;
  overflow: visible;
}
.fix-table thead tr.orig-row th.rn {
  background: #0f172a;
  width: 40px; color: #334155;
  text-align: center; font-size: 10px; padding: 10px 6px;
}
.orig-inner { display: flex; align-items: center; gap: 5px; }
.orig-tag {
  background: rgba(255,255,255,0.07); color: #475569;
  font-size: 9px; padding: 1px 4px; border-radius: 3px;
  text-transform: uppercase; font-weight: 700;
}

/* Row 2 â€” input row */
.fix-table thead tr.input-row th {
  background: #2563eb;
  padding: 7px 10px;
  border-right: 1px solid rgba(255,255,255,0.1);
  border-bottom: 2px solid #1d4ed8;
  position: relative;
  overflow: visible;
}
.fix-table thead tr.input-row th.rn {
  width: 40px; background: #1d4ed8;
}

/* Input */
.hdr-input {
  width: 100%; min-width: 120px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.13);
  border: 1.5px solid rgba(255,255,255,0.22);
  border-radius: 6px;
  color: #fff; font-size: 12px; font-family: inherit;
  outline: none; transition: all 0.15s;
}
.hdr-input::placeholder { color: rgba(255,255,255,0.38); font-size: 11px; }
.hdr-input:focus {
  background: rgba(255,255,255,0.22);
  border-color: rgba(255,255,255,0.6);
}
.hdr-input.filled {
  background: rgba(255,255,255,0.18);
  border-color: rgba(255,255,255,0.45);
  font-weight: 500;
}
.hdr-input.invalid {
  border-color: #fca5a5 !important;
  background: rgba(239,68,68,0.18) !important;
}

/* Resize handle */
.rh {
  position: absolute; top: 0; right: 0;
  width: 18px; height: 100%;
  cursor: col-resize;
  display: flex; align-items: center; justify-content: center;
  opacity: 0.35;
  border-left: 1px solid rgba(255,255,255,0.1);
  transition: opacity 0.15s;
  z-index: 5;
}
.rh:hover { opacity: 1; background: rgba(255,255,255,0.1); }
.rh svg { pointer-events: none; }

/* Body rows */
.fix-table tbody tr:nth-child(odd)  td { background: #ffffff; }
.fix-table tbody tr:nth-child(even) td { background: #f8fafc; }
.fix-table tbody tr:hover td { background: #eff6ff !important; }
.fix-table tbody td {
  padding: 9px 14px;
  font-size: 13px; color: #374151;
  white-space: nowrap;
  border-right: 1px solid #f1f5f9;
  border-bottom: 1px solid #f1f5f9;
  max-width: 200px; overflow: hidden; text-overflow: ellipsis;
}
.fix-table tbody tr:last-child td { border-bottom: none; }
.fix-table tbody td.rn {
  background: #f8fafc !important;
  color: #9ca3af; font-size: 11px; font-weight: 600;
  text-align: center; width: 40px;
  border-right: 1px solid #e5e7eb; padding: 9px 6px;
}
.fix-table tbody td.empty {
  color: #d1d5db; font-style: italic; font-size: 12px;
}

/* â•â• ACTIONS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.actions-bar {
  background: #fff;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  gap: 12px;
}
.actions-hint {
  display: flex; align-items: center; gap: 7px;
  font-size: 12.5px; color: #6b7280;
}
.actions-btns { display: flex; gap: 10px; align-items: center; }

.btn-reset {
  padding: 9px 18px;
  background: #f9fafb; color: #374151;
  border: 1.5px solid #e5e7eb; border-radius: 8px;
  font-size: 13px; font-weight: 600;
  cursor: pointer; font-family: inherit;
  display: inline-flex; align-items: center; gap: 6px;
  transition: all 0.15s;
}
.btn-reset:hover { background: #f3f4f6; border-color: #d1d5db; }

.btn-submit {
  padding: 10px 22px;
  background: #2563eb; color: #fff;
  border: none; border-radius: 8px;
  font-size: 13px; font-weight: 600;
  cursor: pointer; font-family: inherit;
  display: inline-flex; align-items: center; gap: 7px;
  box-shadow: 0 2px 8px rgba(37,99,235,0.28);
  transition: all 0.15s;
}
.btn-submit:hover { background: #1d4ed8; box-shadow: 0 4px 14px rgba(37,99,235,0.35); }

@media (max-width: 640px) {
  .instructions { grid-template-columns: 1fr 1fr; }
  .steps { display: none; }
  .actions-bar { flex-direction: column; align-items: stretch; }
  .actions-btns { justify-content: flex-end; }
}
</style>
{% endblock %}

{% block content %}

<div class="correction-container">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div>
      <div class="page-title">ğŸ”§ Fix Column Headers</div>
      <div class="page-subtitle">Review the original column names (dark row) and type corrected names in the blue input row below</div>
    </div>
    <div class="steps">
      <div class="step done">
        <div class="step-circle">âœ“</div>Upload
      </div>
      <div class="step-line done"></div>
      <div class="step active">
        <div class="step-circle">2</div>Fix Headers
      </div>
      <div class="step-line"></div>
      <div class="step">
        <div class="step-circle">3</div>Done
      </div>
    </div>
  </div>

  <!-- WARNING BANNER -->
  <div class="warn-banner">
    <div class="warn-icon">âš ï¸</div>
    <div class="warn-text">
      <b>Why am I here?</b>
      {% if problem_reason %}
        {{ problem_reason }}
      {% else %}
        Column headers could not be detected automatically. Review the original names in the dark row and type the corrected names in the blue input row â€” use the data preview rows as a guide.
      {% endif %}
    </div>
  </div>

  <!-- INSTRUCTION CARDS -->
  <div class="instructions">
    <div class="instr-card">
      <div class="instr-num">1</div>
      <div class="instr-body"><b>Dark row = original names</b>Read-only â€” exactly as detected in your file.</div>
    </div>
    <div class="instr-card">
      <div class="instr-num">2</div>
      <div class="instr-body"><b>Blue row = your new names</b>Type the correct header in each input box.</div>
    </div>
    <div class="instr-card">
      <div class="instr-num">3</div>
      <div class="instr-body"><b>Drag â‹®â‹® to resize columns</b>Grab the right edge of any header to widen it.</div>
    </div>
    <div class="instr-card">
      <div class="instr-num">4</div>
      <div class="instr-body"><b>Click Apply &amp; Upload</b>File will be saved with the corrected headers.</div>
    </div>
  </div>

  <!-- FORM -->
  <form method="post" action="/upload/fix" id="fix-form">

    <!-- Hidden fields -->
    <input type="hidden" name="temp_id"        value="{{ temp_id }}">
    <input type="hidden" name="category_id"    value="{{ category_id }}">
    <input type="hidden" name="description"    value="{{ description }}">
    <input type="hidden" name="problem_reason" value="{{ problem_reason }}">

    <!-- TABLE CARD -->
    <div class="table-card">
      <div class="table-topbar">
        <div class="table-topbar-label">
          ğŸ“‹ Column Mapping
          <span class="badge badge-amber">10 preview rows</span>
        </div>
        <span class="badge badge-blue">{{ columns | length }} column{{ 's' if columns | length != 1 else '' }} detected</span>
      </div>

      <div class="table-scroll">
        <table class="fix-table" id="fix-table">
          <thead>

            <!-- ROW 1: original headers â€” dark, read-only -->
            <tr class="orig-row">
              <th class="rn">#</th>
              {% for col in columns %}
              <th>
                <div class="orig-inner">
                  {{ col }}
                  <span class="orig-tag">orig</span>
                </div>
                <div class="rh">
                  <svg width="4" height="12" viewBox="0 0 4 12" fill="none">
                    <circle cx="1" cy="1.5"  r="1" fill="rgba(255,255,255,0.7)"/>
                    <circle cx="1" cy="6"    r="1" fill="rgba(255,255,255,0.7)"/>
                    <circle cx="1" cy="10.5" r="1" fill="rgba(255,255,255,0.7)"/>
                    <circle cx="3" cy="1.5"  r="1" fill="rgba(255,255,255,0.7)"/>
                    <circle cx="3" cy="6"    r="1" fill="rgba(255,255,255,0.7)"/>
                    <circle cx="3" cy="10.5" r="1" fill="rgba(255,255,255,0.7)"/>
                  </svg>
                </div>
              </th>
              {% endfor %}
            </tr>

            <!-- ROW 2: input row â€” blue -->
            <tr class="input-row">
              <th class="rn"></th>
              {% for col in columns %}
              <th>
                <input
                  type="text"
                  name="map_{{ col }}"
                  placeholder="Enter header name"
                  class="hdr-input"
                  autocomplete="off"
                  required
                >
              </th>
              {% endfor %}
            </tr>

          </thead>
          <tbody>

            <!-- Preview rows (10 rows) -->
            {% for i in range(10) %}
            <tr>
              <td class="rn">{{ i + 1 }}</td>
              {% for col in columns %}
              {% set cell_val = preview[col][i] if i < preview[col]|length else "" %}
              <td class="{{ 'empty' if cell_val == '' or cell_val == None else '' }}">
                {{ cell_val if cell_val != '' and cell_val != None else "â€”" }}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}

          </tbody>
        </table>
      </div>
    </div>

    <!-- ACTIONS BAR -->
    <div class="actions-bar" style="margin-top:0;">
      <div class="actions-hint">
        <svg width="14" height="14" fill="none" stroke="#9ca3af" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4M12 8h.01"/>
        </svg>
        All fields are required â€” empty inputs will be highlighted on submit
      </div>
      <div class="actions-btns">
        <button type="button" class="btn-reset" id="btn-reset">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
          Reset
        </button>
        <button type="submit" class="btn-submit">
          Apply &amp; Upload
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>

  </form>

</div><!-- /correction-container -->

<script>
(function () {

  /* â”€â”€ 1. Filled-state class on inputs â”€â”€ */
  document.querySelectorAll('.hdr-input').forEach(function (inp) {
    inp.addEventListener('input', function () {
      inp.classList.toggle('filled', inp.value.trim() !== '');
      inp.classList.remove('invalid');
    });
  });

  /* â”€â”€ 2. Reset button â€” clear only the inputs, not hidden fields â”€â”€ */
  document.getElementById('btn-reset').addEventListener('click', function () {
    document.querySelectorAll('.hdr-input').forEach(function (inp) {
      inp.value = '';
      inp.classList.remove('filled', 'invalid');
    });
  });

  /* â”€â”€ 3. Client-side validation â€” highlight empty inputs â”€â”€ */
  document.getElementById('fix-form').addEventListener('submit', function (e) {
    var empty = [];
    document.querySelectorAll('.hdr-input').forEach(function (inp) {
      if (inp.value.trim() === '') {
        inp.classList.add('invalid');
        empty.push(inp);
      }
    });
    if (empty.length > 0) {
      e.preventDefault();
      empty[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      empty[0].focus();
    }
  });

  /* â”€â”€ 4. Column resize â”€â”€ */
  (function initColResize(table) {
    if (!table) return;
    var startX, startW, th;

    table.querySelectorAll('thead tr.orig-row th:not(.rn)').forEach(function (header) {
      var handle = header.querySelector('.rh');
      if (!handle) return;

      handle.addEventListener('mousedown', function (e) {
        e.preventDefault();
        th = header;
        startX = e.pageX;
        startW = th.offsetWidth;
        th.classList.add('resizing');
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    });

    function onMove(e) {
      if (!th) return;
      var newW = Math.max(80, startW + (e.pageX - startX));
      th.style.width = newW + 'px';
      th.style.minWidth = newW + 'px';
      /* sync input-row th width */
      var idx = Array.from(th.parentNode.children).indexOf(th);
      var inputTh = table.querySelector('thead tr.input-row th:nth-child(' + (idx + 1) + ')');
      if (inputTh) { inputTh.style.width = newW + 'px'; inputTh.style.minWidth = newW + 'px'; }
    }

    function onUp() {
      if (th) th.classList.remove('resizing');
      th = null;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
  })(document.getElementById('fix-table'));

})();
</script>
<script>
  // Show loading overlay on form submit
  document.getElementById('fix-form').addEventListener('submit', function () {
    var overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.innerHTML = '<div class="spinner"></div><div class="loading-text">Uploading...</div>';
    document.body.appendChild(overlay);
  });
{% endblock %}